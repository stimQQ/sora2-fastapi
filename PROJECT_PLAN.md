# 项目规划方案 - 视频动画生成平台

## 项目概述
基于阿里云DashScope的视频动画生成服务平台，支持图生动作和视频换人功能，面向全球用户提供服务。

## 一、核心功能
1. **图生动作** (wan2.2-animate-move)：将视频中的动作迁移到静态图片人物
2. **视频换人** (wan2.2-animate-mix)：替换视频中的角色
3. **双认证系统**：国内微信登录，海外Google登录
4. **双支付系统**：国内微信支付，海外Stripe支付
5. **文件存储**：阿里云OSS（国内）+ AWS S3（海外）
6. **任务管理**：异步任务处理与状态追踪

## 二、技术架构

### 2.1 整体架构
```
┌──────────────────────────────────────────────────────┐
│                    前端展示层                          │
├──────────────────────────────────────────────────────┤
│   中国用户                    海外用户                  │
│      ↓                          ↓                     │
│  阿里云OSS/CDN              Vercel全球CDN              │
│  (静态网站托管)              (自动部署)                │
└──────────────────────────────────────────────────────┘
                    ↓ 智能路由 ↓
┌──────────────────────────────────────────────────────┐
│                  统一API网关                           │
├──────────────────────────────────────────────────────┤
│           地域检测 & 服务路由                           │
│    ┌─────────────────┴──────────────────┐            │
│    │                                    │            │
│  中国服务                        全球服务              │
│  - 微信认证                    - Google认证           │
│  - 微信支付                    - Stripe支付           │
│  - 阿里云OSS                   - AWS S3               │
└──────────────────────────────────────────────────────┘
                    ↓
┌──────────────────────────────────────────────────────┐
│                  核心服务层                           │
├──────────────────────────────────────────────────────┤
│  FastAPI应用服务器集群                                │
│  - 用户认证服务                                       │
│  - 任务管理服务                                       │
│  - 支付服务                                          │
│  - 视频处理服务（调用DashScope API）                   │
└──────────────────────────────────────────────────────┘
                    ↓
┌──────────────────────────────────────────────────────┐
│                  数据存储层                           │
├──────────────────────────────────────────────────────┤
│  阿里云RDS        │  Redis缓存      │  对象存储        │
│  (MySQL 8.0)      │  (会话/队列)    │  (OSS/S3)       │
└──────────────────────────────────────────────────────┘
```

### 2.2 技术栈

#### 后端技术栈
- **框架**: FastAPI + Uvicorn + Pydantic
- **数据库**: 阿里云RDS MySQL 8.0
- **缓存**: Redis（会话管理、任务队列）
- **存储**: 阿里云OSS + AWS S3
- **任务队列**: Celery + Redis
- **认证**: JWT + OAuth2.0
- **支付**: 微信支付SDK + Stripe SDK

#### 前端技术栈
- **框架**: Next.js / React
- **状态管理**: Redux / Zustand
- **UI组件**: Ant Design / Material-UI
- **请求库**: Axios / SWR
- **部署**: Vercel（海外） + 阿里云OSS（国内）

## 三、数据库设计

### 3.1 用户表 (users)
```sql
- id: 主键
- nickname: 昵称
- avatar: 头像
- email: 邮箱
- phone: 手机号
- region: 地域（CN/GLOBAL）
- wechat_openid: 微信OpenID
- wechat_unionid: 微信UnionID
- google_id: Google ID
- credits: 账户余额
- vip_level: VIP等级
- created_at: 创建时间
```

### 3.2 任务表 (tasks)
```sql
- id: 主键
- user_id: 用户ID
- task_type: 任务类型（move/mix）
- dashscope_task_id: DashScope任务ID
- input_image_url: 输入图片URL
- input_video_url: 输入视频URL
- output_video_url: 输出视频URL
- status: 状态
- credits_used: 消耗积分
- created_at: 创建时间
```

### 3.3 支付订单表 (payment_orders)
```sql
- id: 订单号
- user_id: 用户ID
- amount: 金额
- currency: 货币类型（CNY/USD）
- payment_method: 支付方式（wechat_pay/stripe）
- status: 状态
- transaction_id: 交易流水号
- created_at: 创建时间
```

## 四、双系统实现方案

### 4.1 地域检测逻辑
1. **IP地址检测**：使用GeoIP2库识别用户地理位置
2. **浏览器语言**：检测浏览器语言设置
3. **用户选择**：允许用户手动切换地域
4. **智能路由**：根据地域自动选择服务

### 4.2 认证系统（模块化设计）
#### 认证架构
- **接口抽象层**：统一认证接口，支持多种登录方式
- **认证提供者**：插件式架构，易于扩展

#### 已支持认证方式
- **中国区域**：微信OAuth2.0（微信内置浏览器/H5）
- **全球区域**：Google OAuth2.0（Google One Tap）

#### 可扩展认证（预留接口）
- Apple ID登录
- GitHub OAuth
- Email/Password
- 手机号验证码

### 4.3 支付系统（模块化设计）
#### 支付架构
- **支付网关抽象**：统一支付接口
- **支付提供者**：插件式架构，动态加载

#### 已支持支付方式
- **中国区域**：微信支付（JSAPI/H5，费率0.6%）
- **全球区域**：Stripe（信用卡/借记卡，费率2.9% + $0.30）

#### 可扩展支付（预留接口）
- 支付宝
- PayPal
- 加密货币
- Apple Pay / Google Pay

## 五、部署方案

### 5.1 前端部署策略

#### 确认方案：单一代码库，多服务器部署
- **代码管理**: 一个前端代码库，统一维护
- **部署策略**:
  - 国内用户 → 阿里云OSS + CDN（中国大陆访问优化）
  - 海外用户 → Vercel（全球CDN，自动部署）
- **DNS智能解析**: 根据用户位置自动路由到最近服务器
- **优势**: 代码维护简单，部署灵活，全球访问优化

### 5.2 后端部署架构

#### 基础设施配置
```yaml
中国区域（阿里云）:
- ECS: 2台（4核8G）+ 海外加速节点
- RDS: MySQL 8.0（主从架构，读写分离）
  - 主库：4核8G（写操作）
  - 从库：2核4G x2（读操作）
- Redis: 4G内存（集群版，会话/缓存/队列）
- OSS: 标准存储
- SLB: 应用型负载均衡

海外加速节点（确认部署）:
- 阿里云国际/AWS（香港/新加坡）
- ECS: 2核4G x2
- 连接国内主数据库（只读）
- 独立Redis缓存
```

### 5.3 容器化部署
- Docker容器化所有服务
- Docker Compose编排
- 可选：Kubernetes（K8s）编排
- CI/CD：GitHub Actions / GitLab CI

## 六、国际化访问优化

### 6.1 访问优化策略
1. **CDN加速**: 静态资源全球CDN分发
2. **边缘计算**: Cloudflare Workers / Vercel Edge Functions
3. **智能DNS**: 根据地域解析到最近节点
4. **API代理**: Vercel Functions代理后端API

### 6.2 性能优化
- 图片/视频压缩优化
- 懒加载和预加载策略
- 缓存策略（浏览器/CDN/Redis）
- 数据库查询优化和索引

## 七、成本预算

### 7.1 月度成本估算
```
国内基础设施:
- 阿里云ECS: ¥800
- RDS数据库: ¥400
- Redis缓存: ¥200
- OSS存储: ¥300
- CDN流量: ¥500
- 备案等其他: ¥100
小计: ¥2,300

国际化部署（可选）:
- Vercel Pro: $20
- AWS/阿里云国际: $200
- Cloudflare: $20
小计: $240（约¥1,700）

总计: ¥2,300 - ¥4,000/月
（不含DashScope API调用费用和支付手续费）
```

### 7.2 交易手续费
- 微信支付: 0.6%
- Stripe: 2.9% + $0.30

## 八、开发计划

### Phase 1: 基础设施搭建（第1-2周）
- [ ] 配置阿里云RDS和Redis
- [ ] 设置OSS存储桶
- [ ] 搭建FastAPI项目框架
- [ ] 实现基础API结构

### Phase 2: 认证系统（第3周）
- [ ] 实现地域检测服务
- [ ] 集成微信登录
- [ ] 集成Google登录
- [ ] 实现JWT认证

### Phase 3: 核心功能（第4周）
- [ ] 文件上传到OSS
- [ ] DashScope API集成
- [ ] 任务管理系统
- [ ] 任务状态查询

### Phase 4: 支付系统（第5周）
- [ ] 集成微信支付
- [ ] 集成Stripe支付
- [ ] 订单管理
- [ ] 支付回调处理

### Phase 5: 前端开发（第6周）
- [ ] 自适应UI组件
- [ ] 登录/支付流程
- [ ] 任务管理界面
- [ ] 多语言支持

### Phase 6: 部署优化（第7周）
- [ ] Docker容器化
- [ ] 配置CI/CD
- [ ] 性能测试
- [ ] 上线部署

### Phase 7: 监控运维（第8周）
- [ ] 日志系统
- [ ] 性能监控
- [ ] 错误追踪
- [ ] 数据分析

## 九、注意事项

### 9.1 合规要求
- **国内**: ICP备案、数据安全法、个人信息保护法
- **国际**: GDPR（欧洲）、CCPA（美国加州）
- **支付**: PCI DSS合规性

### 9.2 安全措施
- API密钥管理（环境变量）
- 数据加密传输（HTTPS）
- SQL注入防护
- XSS/CSRF防护
- 限流和防DDoS

### 9.3 备份策略
- 数据库每日自动备份
- 代码版本控制（Git）
- 文件存储冗余备份
- 灾难恢复计划

## 十、技术支持

### 相关文档
- FastAPI官方文档: https://fastapi.tiangolo.com
- 阿里云DashScope: https://dashscope.aliyun.com
- 微信开放平台: https://open.weixin.qq.com
- Stripe文档: https://stripe.com/docs

### 监控工具
- 阿里云监控
- Google Analytics
- Sentry错误追踪
- Grafana性能监控

---

**已确认事项**：
1. ✅ 采用单一代码库，多服务器部署（阿里云OSS国内 + Vercel海外）
2. ✅ 部署海外加速节点（香港/新加坡）
3. ✅ 数据库采用主从架构，实现读写分离
4. ✅ 支付系统采用模块化设计，支持扩展
5. ✅ 认证系统采用模块化设计，预留扩展接口

**架构更新**：
- 2025-09-29: 确认部署架构和模块化设计方案
- 数据库升级为主从架构，支持读写分离
- 认证和支付系统采用插件式架构
- 确认部署海外加速节点